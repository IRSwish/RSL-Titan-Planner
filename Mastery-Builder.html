<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RSL Tools | Mastery Builder</title>
  <link rel="stylesheet" href="style/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
  /* === Layout === */
  #builder {
    display: flex;
    justify-content: center;
    gap: 40px;
    flex-wrap: wrap;
    margin: 40px auto;
    max-width: 1400px;
  }

  .scroll-counter {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 40px;
    margin-top: 20px;
  }

  .scroll-type {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    color: var(--text-color);
  }

  .scroll-type img {
    width: 36px;
    height: 36px;
  }

  .tree {
    background: var(--event-bg);
    border: 2px solid var(--event-border);
    border-radius: 12px;
    padding: 20px;
    width: 360px;
    text-align: center;
    box-shadow: 0 0 10px rgba(212,175,55,0.2);
    position: relative;
  }

  .tree h2 {
    font-family: 'American Captain';
    color: var(--line-color);
    font-size: 24px;
    margin-bottom: 10px;
  }

  .reset-tree {
    position: absolute;
    top: 10px;
    left: 10px;
    background: linear-gradient(145deg, #1a1a1a, #2b2b2b);
    border: 2px solid var(--event-border);
    color: var(--text-color);
    font-weight: 600;
    font-size: 13px;
    padding: 4px 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .reset-tree:hover {
    transform: scale(1.05);
    box-shadow: 0 0 8px var(--event-border);
  }

  .row {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin: 25px 0;
    position: relative;
  }

  .row.centered {
    justify-content: center;
  }

  .mastery {
    width: 70px;
    height: 70px;
    background: #1a1a1a;
    border: 2px solid #555;
    clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    z-index: 2;
    opacity: 1;
  }

  .mastery:hover {
    box-shadow: 0 0 10px rgba(212,175,55,0.3);
  }

  .mastery.active {
    border-color: var(--line-color);
    box-shadow: 0 0 12px var(--line-color);
    background-color: rgba(212,175,55,0.1);
  }

  .mastery.locked {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* Connection lines */
  .connection {
    position: absolute;
    width: 4px;
    height: 40px;
    left: 50%;
    top: 70px;
    transform: translateX(-50%);
    background: rgba(212,175,55,0.15);
    z-index: 1;
    opacity: 0;
    transition: opacity 0.2s ease, box-shadow 0.3s ease;
  }

  .connection.active {
    opacity: 1;
    background: linear-gradient(to bottom, #d4af37, #fce39b);
    box-shadow: 0 0 10px #d4af37;
  }

  </style>
</head>
<body>
  <div id="menu-container"></div>

  <div class="header-wrapper">
    <header id="page-title">Mastery Builder</header>
  </div>

  <div class="scroll-counter">
    <div class="scroll-type" id="basic-scrolls">
      <img src="style/img/Misc/Scroll-Basic.webp" alt="Basic Scrolls">
      <span>0 / 100</span>
    </div>
    <div class="scroll-type" id="advanced-scrolls">
      <img src="style/img/Misc/Scroll-Advanced.webp" alt="Advanced Scrolls">
      <span>0 / 600</span>
    </div>
    <div class="scroll-type" id="divine-scrolls">
      <img src="style/img/Misc/Scroll-Divine.webp" alt="Divine Scrolls">
      <span>0 / 950</span>
    </div>
  </div>

  <div id="builder">
    <div class="tree" data-branch="offense">
      <button class="reset-tree">Reset</button>
      <h2>Offense</h2>
      <div class="rows"></div>
    </div>

    <div class="tree" data-branch="defense">
      <button class="reset-tree">Reset</button>
      <h2>Defense</h2>
      <div class="rows"></div>
    </div>

    <div class="tree" data-branch="support">
      <button class="reset-tree">Reset</button>
      <h2>Support</h2>
      <div class="rows"></div>
    </div>
  </div>

<script>
(() => {
  // ---- CONFIG ----
  const layout = [2, 4, 4, 4, 4, 4]; // 6 rangées
  const tierCost = { 1: 5, 2: 5, 3: 30, 4: 30, 5: 200, 6: 350 };

  // ---- BUILD (idempotent) ----
  const trees = document.querySelectorAll(".tree");
  trees.forEach(tree => {
    if (tree.dataset.initialized) return;
    tree.dataset.initialized = "1";
    const branch = tree.dataset.branch;
    const rows = tree.querySelector(".rows") || (() => {
      const d = document.createElement("div"); d.className = "rows"; tree.appendChild(d); return d;
    })();

    layout.forEach((cols, rowIdx) => {
      const row = document.createElement("div");
      row.className = "row" + (cols === 2 ? " centered" : "");
      rows.appendChild(row);
      for (let col = 0; col < cols; col++) {
        const m = document.createElement("div");
        m.className = "mastery";
        m.dataset.id = `${branch}-${rowIdx + 1}-${col + 1}`;
        // petite connexion verticale (visuelle) optionnelle :
        if (rowIdx < layout.length - 1) {
          const conn = document.createElement("div");
          conn.className = "connection";
          conn.dataset.from = `${branch}-${rowIdx + 1}-${col + 1}`;
          conn.dataset.to = `${branch}-${rowIdx + 2}-${col + 1}`;
          m.appendChild(conn);
        }
        row.appendChild(m);
      }
    });

    // bouton reset par arbre
    const resetBtn = tree.querySelector(".reset-tree");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        tree.querySelectorAll(".mastery.active").forEach(el => el.classList.remove("active"));
        updateAll();
      });
    }
  });

  const masteries = Array.from(document.querySelectorAll(".mastery"));
  const scrollDisplay = {
    basic: document.querySelector("#basic-scrolls span"),
    advanced: document.querySelector("#advanced-scrolls span"),
    divine: document.querySelector("#divine-scrolls span"),
  };

  // ---- EVENTS ----
  masteries.forEach(m => {
    m.addEventListener("click", () => {
      if (m.classList.contains("locked")) return;

      const [branch, tierStr] = m.dataset.id.split("-");
      const tier = parseInt(tierStr, 10);

      // toggle avec validation
      if (m.classList.contains("active")) {
        m.classList.remove("active");
      } else {
        if (!canSelect(m)) return;
        m.classList.add("active");
      }
      updateAll();
    });
  });

  // ---- RULES / STATE ----
  function getState() {
    const active = new Set(
      Array.from(document.querySelectorAll(".mastery.active")).map(el => el.dataset.id)
    );
    const perTier = {};
    const perTree235 = { offense: 0, defense: 0, support: 0 };
    let total235 = 0;
    let totalT6 = 0;
    const activeTrees = new Set();

    active.forEach(id => {
      const [b, tStr] = id.split("-");
      const t = parseInt(tStr, 10);
      activeTrees.add(b);
      perTier[t] = (perTier[t] || 0) + 1;
      if (t >= 2 && t <= 5) {
        total235 += 1;
        perTree235[b] += 1;
      }
      if (t === 6) totalT6 += 1;
    });

    return { active, activeTrees, perTier, total235, perTree235, totalT6 };
  }

  // connexion permise si parent actif sur rangée précédente (col, col-1, col+1)
  function isConnected(m) {
    const [branch, tierStr, colStr] = m.dataset.id.split("-");
    const tier = parseInt(tierStr, 10);
    const col = parseInt(colStr, 10);
    if (tier === 1) return true;
    const prevTier = tier - 1;
    for (let d of [-1, 0, 1]) {
      const prev = document.querySelector(`[data-id="${branch}-${prevTier}-${col + d}"]`);
      if (prev && prev.classList.contains("active")) return true;
    }
    return false;
  }

  // règle principale de sélection
  function canSelect(m) {
    const { active, activeTrees, perTier, total235, perTree235, totalT6 } = getState();
    const [branch, tierStr] = m.dataset.id.split("-");
    const tier = parseInt(tierStr, 10);

    // max 2 arbres
    if (!Array.from(activeTrees).includes(branch) && activeTrees.size >= 2) return false;

    // connectivity
    if (!isConnected(m)) return false;

    // contraintes par tiers
    if (tier === 1) {
      // 1 seule maîtrise sur la ligne 1 PAR ARBRE
      const alreadyInThisTreeT1 = document.querySelectorAll(`.mastery.active[data-id^="${branch}-1-"]`).length;
      if (alreadyInThisTreeT1 >= 1) return false;
      return true;
    }

    if (tier >= 2 && tier <= 5) {
      // total max 3 sur T2–T5 (tous arbres confondus)
      if (total235 >= 3) return false;
      // max 2 sur T2–T5 dans le même arbre
      if (perTree235[branch] >= 2) return false;
      return true;
    }

    if (tier === 6) {
      // 1 seule maîtrise sur la dernière ligne au global
      if (totalT6 >= 1) return false;
      return true;
    }

    return true;
  }

  function updateConnections() {
    document.querySelectorAll(".connection").forEach(c => {
      const from = document.querySelector(`[data-id="${c.dataset.from}"]`);
      const to = document.querySelector(`[data-id="${c.dataset.to}"]`);
      c.classList.toggle(
        "active",
        !!(from && to && from.classList.contains("active") && to.classList.contains("active"))
      );
    });
  }

  function updateLocks() {
    const { activeTrees, total235, perTree235 } = getState();

    masteries.forEach(m => {
      if (m.classList.contains("active")) {
        m.classList.remove("locked");
        return;
      }
      const [branch, tierStr] = m.dataset.id.split("-");
      const tier = parseInt(tierStr, 10);
      let lock = false;

      // 3e arbre bloqué si déjà 2 arbres commencés
      if (!Array.from(activeTrees).includes(branch) && activeTrees.size >= 2) lock = true;

      // connectivité
      if (!isConnected(m) && tier > 1) lock = true;

      // règles de quotas
      if (tier === 1) {
        // 1 seule en T1 par arbre
        const t1InTree = document.querySelectorAll(`.mastery.active[data-id^="${branch}-1-"]`).length;
        if (t1InTree >= 1) lock = true;
      } else if (tier >= 2 && tier <= 5) {
        if (total235 >= 3) lock = true;
        if (perTree235[branch] >= 2) lock = true;
      } else if (tier === 6) {
        const anyT6 = document.querySelector('.mastery.active[data-id*="-6-"]');
        if (anyT6) lock = true;
      }

      m.classList.toggle("locked", lock);
    });
  }

  function updateScrolls() {
    let basic = 0, advanced = 0, divine = 0;
    document.querySelectorAll(".mastery.active").forEach(m => {
      const tier = parseInt(m.dataset.id.split("-")[1], 10);
      const cost = tierCost[tier] || 0;
      if (tier <= 2) basic += cost;
      else if (tier <= 4) advanced += cost;
      else divine += cost;
    });
    if (scrollDisplay.basic) scrollDisplay.basic.textContent = `${Math.min(basic, 100)} / 100`;
    if (scrollDisplay.advanced) scrollDisplay.advanced.textContent = `${Math.min(advanced, 600)} / 600`;
    if (scrollDisplay.divine) scrollDisplay.divine.textContent = `${Math.min(divine, 950)} / 950`;
  }

  function updateAll() {
    updateConnections();
    updateLocks();
    updateScrolls();
  }

  // initial
  updateAll();

  // support du lien ?m= (si tu l’utilises encore)
  const params = new URLSearchParams(location.search);
  if (params.has("m")) {
    const ids = atob(params.get("m")).split(",");
    ids.forEach(id => document.querySelector(`[data-id="${id}"]`)?.classList.add("active"));
    updateAll();
  }
})();
</script>

</body>
</html>
